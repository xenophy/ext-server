<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/* vim: set expandtab tabstop=4 shiftwidth=4 softtabstop=4: */

/*!
 * Ext Server
 * Copyright (c)2012 Xenophy.CO.,LTD All rights Reserved.
 * MIT Licensed
 */

<span id='Ext'>/**
</span> * @class Ext
 *
 * {Ext:doc-contents}
 *
 * @singleton
 */
(function() {

    if(typeof global.Ext === 'undefined') {
        global.Ext = { global: global };
    }

    Ext.node = {
        path    : require('path'),
        fs      : require('fs')
    };

    var path            = Ext.node.path,
        fs              = Ext.node.fs,
        objectPrototype = Object.prototype,
        toString        = objectPrototype.toString;

    // Ext Server Enviroment
    process.ExtEnv = {
        lang        : 'ja_JP',
        dirname     : path.dirname(process.argv[1]),
        basename    : path.dirname(process.argv[1]),
        libdir      : __dirname,
        resourcedir : fs.realpathSync(__dirname + '/../resources')
    };

    // {{{ apply

<span id='Ext-method-apply'>    /**
</span>     * {Ext:method-apply:desc}
     *
     * @param {Object} object {Ext:method-apply:param_object}
     * @param {Object} config {Ext:method-apply:param_config}
     * @param {Object} defaults {Ext:method-apply:param_defaults}
     * @return {Object} {Ext:method-apply:return}
     */
    Ext.apply = function(o, config, defaults) {

        if(defaults) {
            Ext.apply(o, defaults);
        }

        if(o &amp;&amp; config &amp;&amp; typeof config === 'object') {

            var i, j, k;

            for(i in config) {
                o[i] = config[i];
            }

        }

        return o;
    };

    // }}}

    Ext.apply(Ext, {

        // {{{ name

<span id='Ext-property-name'>        /**
</span>         * @property {String} [name='Ext']
         *
         * {Ext:property-name:desc}
         */
        name: Ext.sandboxName || 'Ext',

        // }}}
        // {{{ emptyString

<span id='Ext-property-emptyString'>        /**
</span>         * {Ext:property-emptyString:desc}
         */
        emptyString: new String(),

        // }}}
        // {{{ $requires

        // private
        $requires: {},

        // }}}
        // {{{ $locale

        // private
        $locale: {},

        // }}}
        // {{{ $e

        // private
        $e: function(key) {

            var arg = [Ext.$locale[key]];

            Ext.iterate(arguments, function(item, i) {
                if(i &gt; 0) {
                    arg.push(item);
                }
            });

            return Ext.String.format.apply(this, arg);
        },

        // }}}
        // {{{ emptyFn

<span id='Ext-method-emptyFn'>        /**
</span>         * {Ext:method-emptyFn:desc}
         *
         * @method
         */
        emptyFn: function() {
        },

        // }}}
        // {{{ applyIf

<span id='Ext-method-applyIf'>        /**
</span>         * {Ext:method-applyIf:desc}
         *
         * @param {Object} object {Ext:method-applyIf:param_object}
         * @param {Object} config {Ext:method-applyIf:param_config}
         * @return {Object} {Ext:method-applyIf:return}
         */
        applyIf: function(o, config) {

            var prop;

            if(o) {
                for(prop in config) {
                    if(o[prop] === undefined) {
                        o[prop] = config[prop];
                    }
                }
            }
            return o;
        },

        // }}}
        // {{{ iterate

<span id='Ext-method-iterate'>        /**
</span>         * {Ext:method-iterate:desc}
         *
         * @param {Object/Array} object {Ext:method-iterate:param_object}
         * @param {Function} fn {Ext:method-iterate:param_fn}
         * @param {Object} scope {Ext:method-iterate:param_scope}
         */
        iterate: function(object, fn, scope) {

            if(Ext.isEmpty(object)) {
                return;
            }

            if(scope === undefined) {
                scope = object;
            }

            if(Ext.isIterable(object)) {

                Ext.Array.each.call(Ext.Array, object, fn, scope);

            } else {

                Ext.Object.each.call(Ext.Object, object, fn, scope);

            }
        }

        // }}}

    });

    Ext.apply(Ext, {

        // {{{ valueFrom

<span id='Ext-method-valueFrom'>        /**
</span>         * {Ext:method-valueFrom:desc}
         *
         * @param {Object} value {Ext:method-valueFrom:param_value}
         * @param {Object} defaultValue {Ext:method-valueFrom:param_defaultValue}
         * @param {Boolean} allowBlank {Ext:method-valueFrom:param_allowBlank}
         * @return {Object} {Ext:method-valueFrom:return}
         */
        valueFrom: function(value, defaultValue, allowBlank){
            return Ext.isEmpty(value, allowBlank) ? defaultValue : value;
        },

        // }}}
        // {{{ typeOf

<span id='Ext-method-typeOf'>        /**
</span>         * {Ext:method-typeOf:desc}
         *
         * @param {Object} value {Ext:method-typeOf:param_value}
         * @return {String} {Ext:method-typeOf:return}
         */
        typeOf: function(value) {

            var type,
                typeToString;

            if(value === null) {
                return 'null';
            }

            type = typeof value;

            if(type === 'undefined' || type === 'string' || type === 'number' || type === 'boolean') {
                return type;
            }

            typeToString = toString.call(value);

            switch(typeToString) {
                case '[object Array]':
                    return 'array';
                case '[object Date]':
                    return 'date';
                case '[object Boolean]':
                    return 'boolean';
                case '[object Number]':
                    return 'number';
                case '[object RegExp]':
                    return 'regexp';
            }

            if(type === 'function') {
                return 'function';
            }

        },

        // }}}
        // {{{ isSimpleObject

<span id='Ext-method-isSimpleObject'>        /**
</span>         * @private
         */
        isSimpleObject: function(value) {
            return value instanceof Object &amp;&amp; value.constructor === Object;
        },

        // }}}
        // {{{ isArray

<span id='Ext-method-isArray'>        /**
</span>         * {Ext:method-isArray:desc}
         *
         * @param {Object} target {Ext:method-isArray:param_target}
         * @return {Boolean} {Ext:method-isArray:return}
         */
        isArray: Array.isArray,

        // }}}
        // {{{ isBoolean

<span id='Ext-method-isBoolean'>        /**
</span>         * {Ext:method-isBoolean:desc}
         *
         * @param {Object} value {Ext:method-isBoolean:param_value}
         * @return {Boolean} {Ext:method-isBoolean:return}
         */
        isBoolean: function(value) {
            return typeof value === 'boolean';
        },

        // }}}
        // {{{ isDate

<span id='Ext-method-isDate'>        /**
</span>         * {Ext:method-isDate:desc}
         *
         * @param {Object} object {Ext:method-isDate:param_object}
         * @return {Boolean} {Ext:method-isDate:return}
         */
        isDate: function(value) {
            return toString.call(value) === '[object Date]';
        },

        // }}}
        // {{{ isDefined

<span id='Ext-method-isDefined'>        /**
</span>         * {Ext:method-isDefined:desc}
         *
         * @param {Object} value {Ext:method-isDefined:param_value}
         * @return {Boolean} {Ext:method-isDefined:return}
         */
        isDefined: function(value) {
            return typeof value !== 'undefined';
        },

        // }}}
        // {{{ isEmpty

<span id='Ext-method-isEmpty'>        /**
</span>         * {Ext:method-isEmpty:desc}
         *
         * @param {Object} value {Ext:method-isEmpty:param_value}
         * @param {Boolean} allowEmptyString {Ext:method-isEmpty:param_allowEmptyString}
         * @return {Boolean} {Ext:method-isEmpty:return}
         */
        isEmpty: function(value, allowEmptyString) {
            return (
                (value === null) ||
                (value === undefined) ||
                (!allowEmptyString ? value === '' : false) ||
                (Ext.isArray(value) &amp;&amp; value.length === 0)
            );
        },

        // }}}
        // {{{ isFunction

<span id='Ext-method-isFunction'>        /**
</span>         * {Ext:method-isFunction:desc}
         *
         * @param {Object} value {Ext:method-isFunction:param_value}
         * @return {Boolean} {Ext:method-isFunction:return}
         */
        isFunction: function(value) {
            return typeof value === 'function';
        },

        // }}}
        // {{{ isIterable

<span id='Ext-method-isIterable'>        /**
</span>         * {Ext:method-isIterable:desc}
         *
         * @param {Object} value {Ext:method-isIterable:param_value}
         * @return {Boolean} {Ext:method-isIterable:return}
         */
        isIterable: function(value) {
            return (
                (value &amp;&amp; typeof value !== 'string')
                ? value.length !== undefined
                : false
            );
        },

        // }}}
        // {{{ isNumber

<span id='Ext-method-isNumber'>        /**
</span>         * {Ext:method-isNumber:desc}
         *
         * @param {Object} value {Ext:method-isNumber:param_value}
         * @return {Boolean} {Ext:method-isNumber:return}
         */
        isNumber: function(value) {
            return typeof value === 'number' &amp;&amp; isFinite(value);
        },

        // }}}
        // {{{ isNumeric

<span id='Ext-method-isNumeric'>        /**
</span>         * {Ext:method-isNumeric:desc}
         *
         * @param {Object} value {Ext:method-isNumeric:param_value}
         * @return {Boolean} {Ext:method-isNumeric:return}
         */
        isNumeric: function(value) {
            return !isNaN(parseFloat(value)) &amp;&amp; isFinite(value);
        },

        // }}}
        // {{{ isObject

<span id='Ext-method-isObject'>        /**
</span>         * {Ext:method-isObject:desc}
         *
         * @param {Object} value {Ext:method-isObject:param_value}
         * @return {Boolean} {Ext:method-isObject:return}
         */
        isObject: function(value) {
            return toString.call(value) === '[object Object]';
        },

        // }}}
        // {{{ isPrimitive

<span id='Ext-method-isPrimitive'>        /**
</span>         * {Ext:method-isPrimitive:desc}
         *
         * @param {Object} value {Ext:method-isPrimitive:param_value}
         * @return {Boolean} {Ext:method-isPrimitive:return}
         */
        isPrimitive: function(value) {

            var type = typeof value;

            return (
                type === 'string' ||
                type === 'number' ||
                type === 'boolean'
            );
        },

        // }}}
        // {{{ isString

<span id='Ext-method-isString'>        /**
</span>         * {Ext:method-isString:desc}
         *
         * @param {Object} value {Ext:method-isString:param_value}
         * @return {Boolean} {Ext:method-isString:return}
         */
        isString: function(value) {
            return typeof value === 'string';
        }

        // }}}

    });

    Ext.apply(Ext, {

        // {{{ clone

<span id='Ext-method-clone'>        /**
</span>         * {Ext:method-clone:desc}
         *
         * @param {Object} item {Ext:method-clone:param_item}
         * @return {Object} {Ext:method-clone:return}
         */
        clone: function(item) {

            if(item === null || item === undefined) {
                return item;
            }

            var type = toString.call(item);

            if(type === '[object Date]') {
                return new Date(item.getTime());
            }

            var i, j, k, clone, key;

            if(type === '[object Array]') {

                i = item.length;
                clone = [];

                while(i--) {
                    clone[i] = Ext.clone(item[i]);
                }

            } else if(type === '[object Object]' &amp;&amp; item.constructor === Object) {

                clone = {};

                for(key in item) {
                    clone[key] = Ext.clone(item[key]);
                }

            }

            return clone || item;

        },

        // }}}
        // {{{ functionFactory

        // private
        functionFactory: function() {

            var args = Array.prototype.slice.call(arguments);

            if(args.length &gt; 0) {
                args[args.length - 1] = [
                    /*
                    'var Ext=global.',
                    this.getUniqueGlobalNamespace(),
                    ';',
                    */
                    args[args.length - 1]
                ].join('');
            }

            return Function.prototype.constructor.apply(Function.prototype, args);
        },

        // }}}
        // {{{ getRandomInt

<span id='Ext-method-getRandomInt'>        /**
</span>         * {Ext:method-getRandomInt:desc}
         *
         * @param {Number} min {Ext:method-getRandomInt:param_min}
         * @param {Number} max {Ext:method-getRandomInt:param_max}
         * @return {Number} {Ext:method-getRandomInt:return}
         */
        getRandomInt: function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        },

        // }}}
        // {{{ getUniqueGlobalNamespace

        /*
        // private
        getUniqueGlobalNamespace: function() {

            var uniqueGlobalNamespace = this.uniqueGlobalNamespace;

            if(uniqueGlobalNamespace === undefined) {

                var i = 0;

                do {
                    uniqueGlobalNamespace = 'ExtBox' + (++i);
                } while (Ext.global[uniqueGlobalNamespace] !== undefined);

                Ext.global[uniqueGlobalNamespace] = Ext;
                this.uniqueGlobalNamespace = uniqueGlobalNamespace;
            }

            return uniqueGlobalNamespace;
        },
        */

        // }}}
        // {{{ moduleCacheClear

<span id='Ext-method-moduleCacheClear'>        /**
</span>         * {Ext:method-moduleCacheClear:desc}
         *
         * @param {String} path {Ext:method-moduleCacheClear:param_path}
         * @param {Number} mtime {Ext:method-moduleCacheClear:param_mtime}
         */
        moduleCacheClear: function(path, mtime) {

            if(require.cache[path]) {

                if(!Ext.$requires[path]) {
                    Ext.$requires[path] = {};
                }

                var prev = Ext.$requires[path].mtime || new Date(1900, 1, 1);

                if(mtime &amp;&amp; prev &lt; mtime) {

                    delete require.cache[path];

                    Ext.$requires[path].mtime = mtime;
                }

            }

        },

        // }}}
        // {{{ setLocale

<span id='Ext-method-setLocale'>        /**
</span>         * {Ext:method-setLocale:desc}
         *
         * @param {String} locale {Ext:method-setLocale:param_locale}
         * @return {Boolean} {Ext:method-setLocale:return}
         */
        setLocale: function(locale) {

            try {
                locale = locale || 'en';
                locale = Ext.String.replace(locale, '/', '');
                Ext.apply(
                    Ext.$locale,
                    Ext.JSON.decode(
                        require('fs').readFileSync(
                            require('path').normalize(__dirname + '/../locale/' + locale + '.json')
                        ).toString()
                    )
                );
            } catch(e) {
            }

        },

        // }}}
        // {{{ uid

<span id='Ext-method-uid'>        /**
</span>         * {Ext:method-uid:desc}
         *
         * @param {Number} len {Ext:method-uid:param_len}
         * @return {String} {Ext:method-uid:return}
         */
        uid: function(len) {

            var buf = [],
                ret = [],
                chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789',
                charlen = chars.length;

            for(var i = 0; i &lt; len; ++i) {
                buf.push(chars[Ext.getRandomInt(0, charlen - 1)]);
            }

            return buf.join('');
        },

        // }}}
        // {{{ Logger

<span id='Logger'>        /**
</span>         * @private
         */
        Logger: {
            verbose: Ext.emptyFn,
            log: Ext.emptyFn,
            info: Ext.emptyFn,
            warn: Ext.emptyFn,
            error: function(message) {
                throw new Error(message);
            },
            deprecate: Ext.emptyFn
        }

        // }}}

    });

    // Ext.Error
    require('./lang/Error');

    Ext.apply(Ext, {

        // Ext.Array
        Array: require('./lang/Array'),

        // Ext.Date
        Date: require('./lang/Date'),

        // Ext.Function
        Function: require('./lang/Function'),

        // Ext.JSON
        JSON: require('./misc/JSON'),

        // Ext.Number
        Number: require('./lang/Number'),

        // Ext.Object
        Object: require('./lang/Object'),

        // Ext.String
        String: require('./lang/String'),

        // Ext.util
        util: {}

    });

    Ext.apply(Ext.util, {

        // Ext.util.Markdown
        Markdown: require('./util/Markdown'),

        // Ext.util.Format
        Format: require('./util/Format'),

        // Ext.util.OTP
        OTP: require('./util/OTP'),

        // Ext.util.GeoIP
        GeoIP: require('./util/GeoIP'),

        // Ext.util.Obfuscator
        Obfuscator: require('./util/Obfuscator')

    });

    // create shorthand
    Ext.apply(Ext, {

        // {{{ toArray

<span id='Ext-method-toArray'>        /**
</span>         * {Ext:method-toArray:desc}
         * @method toArray
         * @member Ext
         */
        toArray: function() {
            return Ext.Array.toArray.apply(Ext.Array, arguments);
        },

        // }}}
        // {{{ merge

<span id='Ext-method-merge'>        /**
</span>         * {Ext:method-merge:desc}
         * @member Ext
         * @method merge
         */
        merge: Ext.Object.merge,

        // }}}
        // {{{ margeIf

<span id='Logger-property-mergeIf'>        /**
</span>         * @private
         */
        mergeIf: Ext.Object.mergeIf,

        // }}}
        // {{{ each

<span id='Ext-method-each'>        /**
</span>         * {Ext:method-each:desc}
         * @member Ext
         * @method each
         */
        each: Ext.Array.each,

        // }}}
        // {{{ union

<span id='Ext-method-union'>        /**
</span>         * {Ext:method-union:desc}
         * @member Ext
         * @method union
         */
        union: Ext.Array.merge,

        // }}}
        // {{{ markdown

<span id='Ext-method-markdown'>        /**
</span>         * {Ext:method-markdown:desc}
         * @method markdown
         * @member Ext
         */
        markdown: Ext.util.Markdown.parse,

        // }}}
        // {{{ encode

<span id='Ext-method-encode'>        /**
</span>         * {Ext:method-encode:desc}
         * @method encode
         * @member Ext
         */
        encode: Ext.JSON.encode,

        // }}}
        // {{{ decode

<span id='Ext-method-decode'>        /**
</span>         * {Ext:method-decode:desc}
         * @method decode
         * @member Ext
         */
        decode: Ext.JSON.decode,

        // }}}
        // {{{ defer

        defer: Ext.Function.defer

        // }}}

    });

    // exports Ext
    module.exports = global.Ext;

    // locale setting
    var locale = process.env.LANG || 'en';

    if(Ext.isString(process.env.LANG)) {
        var tmp = process.env.LANG.split('_');
        if(Ext.isArray(tmp)) {
            locale = tmp[0];
        }
    }
    Ext.setLocale(locale);

    // require core files
    require('./class/Base');
    require('./class/Class');
    require('./class/ClassManager');
    require('./class/Loader');
    require('./version/Version');

    // dependencies
    Ext.$dependencies = {

        // {{{ connect

        connect: require('connect'),

        // }}}
        // {{{ connect-redis

        'connect-redis': require('connect-redis'),

        // }}}
        // {{{ socket.io

        'socket.io': require('socket.io'),

        // }}}
        // {{{ mime

        mime: require('mime'),

        // }}}
        // {{{ mysql

        mysql: require('mysql'),

        // }}}
        // {{{ mongodb

        mongodb: require('mongodb'),

        // }}}
        // {{{ swig

        swig: require('swig'),

        // }}}
        // {{{ ejs

        ejs: require('ejs'),

        // }}}
        // {{{ nodemailer

        nodemailer: require('nodemailer'),

        // }}}
        // {{{ debug

        debug: require('debug'),

        // }}}
        // {{{ http-proxy

        'http-proxy': require('http-proxy')

        // }}}

    };

    // Loader Setting
    Ext.Loader.setConfig({
        enabled: true,
        paths: {
            Ext: process.ExtEnv.libdir
        }
    });

    // require classes
    [
        'Ext.app.Application',
        'Ext.server.proxy.Reverse',
        'Ext.database.Manager',
        'Ext.logger.Logger'

    ].forEach(function(item) {
        Ext.Loader.require(item);
    });

})();

// {{{ globalEval

/*
 * This method evaluates the given code free of any local variable. In some browsers this
 * will be at global scope, in others it will be in a function.
 *
 * @parma {String} code The code to evaluate.
 * @private
 * @method
 */
Ext.globalEval = function($$code) {
    (function(){
        eval($$code);
    }());
};

// }}}

/*
 * Local variables:
 * tab-width: 4
 * c-basic-offset: 4
 * c-hanging-comment-ender-p: nil
 * End:
 */
</pre>
</body>
</html>
